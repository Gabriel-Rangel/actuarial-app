
{% extends "layout.html" %}

{% block content %}
<main role="main" class="col-md-9 col-lg-10 px-md-4">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h1">Approval ðŸ’¯</h1>
    </div>

    <!-- Welcome Message -->
    <div id="welcome-message" class="alert alert-light rounded shadow-sm p-4 mb-4">
        Hi {{ user_name }}! ðŸ‘‹ Welcome to your Variable Annuities Payoff Approval Form. Here, you can approve, reject, and modify modeled payoffs!
    </div>

    <section>
        <div class="row">
            <div class="col-md-5 d-flex flex-column">
                <h2 class="h4">Modeled Payoffs</h2>
                <div class="table-responsive flex-grow-1" style="height: 300px; overflow-y: auto;">
                    <table id="table1" class="table table-striped table-bordered h-100">
                        <thead class="thead-dark">
                            <tr>
                                <th>Product</th>
                                <th>Modeled Payoff</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr>
                                <td><strong>{{ item.productType }}</strong></td>
                                <td style="text-align: right;">{{ item.Payoffs }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-7 d-flex flex-column">
                <h2 class="h4">Adjustments</h2>
                <div class="table-responsive flex-grow-1" style="height: 300px; overflow-y: auto;">
                    <form action="/submit_approval" method="post" class="d-flex flex-column h-100">
                        <table id="table2" class="table table-striped table-bordered h-100">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width:20%;">Product</th>
                                    <th style="width:30%;">Adjustment</th>
                                    <th style="width:50%;">Comments</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in data %}
                                <tr>
                                    <td><strong>{{ item.productType }}</strong></td>
                                    <td><input type="number" class="form-control" name="adj_{{ item.productType }}" value=0></td>
                                    <td><input type="text" class="form-control" name="comments_{{ item.productType }}" value=""></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                </div>
            </div>
        </div>

        <div class="form-group mt-3">
            <label for="action"><strong>Action: </strong><span class="text-danger">*</span></label>
            <select class="form-control" id="action" name="action" required>
                <option value="">Select Action</option>
                <option value="Approved">Approve</option>
                <option value="Rejected">Reject</option>
            </select>
        </div>
        <div class="form-group mt-3">
            <label for="comments"><strong>Comments: </strong></label>
            <textarea class="form-control" id="comments" name="comments" rows="3" style="width: 100%;"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-3" style="width: 80px;">Submit</button>
        </form>

        <div class="mt-5">
            <h2 class="h4">Final Payoffs</h2>
            <div class="table-responsive">
                <table id="sumTable" class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th>Product</th>
                            <th>Modeled</th>
                            <th>Adjustment</th>
                            <th>Total Payoff</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in final_data %}
                        <tr data-product="{{ item.productType }}">
                            <td><strong>{{ item.productType }}</strong></td>
                            <td class="payoff" style="text-align: right;">{{ item.Modeled }}</td>
                            <td class="adj" style="text-align: right;">{{ item.adj }}</td>
                            <td class="total" style="text-align: right;">{{ item.Payoffs }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-5">
            <h2 class="h4">Review Log</h2>
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>Date</th>
                        <th>User Name</th>
                        <th>Action</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2025-04-28 15:23:17</td>
                        <td>Stephen Hsu</td>
                        <td>Model results submitted</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>2025-05-10 09:24:30</td>
                        <td>Suman Misra</td>
                        <td>Rejected</td>
                        <td>Review negative payoffs in DBRU</td>
                    </tr>
                    <tr>
                        <td>2025-05-11 11:03:43</td>
                        <td>Shirly Wang</td>
                        <td>Model results submitted</td>
                        <td></td>
                    </tr>
                    {% for log in review_log %}
                    <tr>
                        <td>{{ log.date }}</td>
                        <td>{{ log.user_name }}</td>
                        <td>{{ log.action }}</td>
                        <td>{{ log.comments }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            var table1Rows = document.querySelectorAll('#table1 tbody tr');
            var table2Rows = document.querySelectorAll('#table2 tbody tr');
            var rowCount = Math.min(table1Rows.length, table2Rows.length);
        
            for (var i = 0; i < rowCount; i++) {
                // Reset heights first (important if resizing)
                table1Rows[i].style.height = '';
                table2Rows[i].style.height = '';
        
                var h1 = table1Rows[i].offsetHeight;
                var h2 = table2Rows[i].offsetHeight;
                var maxHeight = Math.max(h1, h2);
        
                table1Rows[i].style.height = maxHeight + 'px';
                table2Rows[i].style.height = maxHeight + 'px';
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // For each adjustment input, update the sum table on input
            document.querySelectorAll('input[name^="adj_"]').forEach(function(input) {
                input.addEventListener('input', function() {
                    var product = this.name.replace('adj_', '');
                    var payoffCell = document.querySelector('#sumTable tr[data-product="' + product + '"] .payoff');
                    var adjCell = document.querySelector('#sumTable tr[data-product="' + product + '"] .adj');
                    var totalCell = document.querySelector('#sumTable tr[data-product="' + product + '"] .total');
                    var payoff = parseFloat(payoffCell.textContent.replace(/,/g, '')) || 0; // Remove commas if present
                    var adj = parseFloat(this.value) || 0;
                    adjCell.textContent = adj.toLocaleString();
                    totalCell.textContent = (payoff + adj).toLocaleString();
                });
            });
        });
    </script>
</main>
{% endblock %}

